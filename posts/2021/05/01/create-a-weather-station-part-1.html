<!DOCTYPE html>
<html lang="fr-FR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Créer sa station météo - partie 1 | Steffy&#39;s blog</title>
    <meta name="description" content=" ">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="preload" href="/assets/js/vendor.vue.dbbf1d4d.js" as="script"><link rel="preload" href="/assets/css/0.styles.4e55ef28.css" as="style"><link rel="preload" href="/assets/js/vendor.commons.4e55ef28.js" as="script"><link rel="preload" href="/assets/css/styles.4ccb282b.css" as="style"><link rel="preload" href="/assets/js/app.4ccb282b.js" as="script"><link rel="preload" href="/assets/css/8.styles.992b9188.css" as="style"><link rel="preload" href="/assets/js/8.992b9188.js" as="script"><link rel="preload" href="/assets/js/20.a2ce34d7.js" as="script"><link rel="prefetch" href="/assets/css/1.styles.adfae322.css"><link rel="prefetch" href="/assets/css/4.styles.933c17d3.css"><link rel="prefetch" href="/assets/css/5.styles.52a6c039.css"><link rel="prefetch" href="/assets/css/6.styles.1fd7acb8.css"><link rel="prefetch" href="/assets/css/7.styles.40cf13a3.css"><link rel="prefetch" href="/assets/js/1.adfae322.js"><link rel="prefetch" href="/assets/js/10.376089a0.js"><link rel="prefetch" href="/assets/js/11.0099b55f.js"><link rel="prefetch" href="/assets/js/12.f7467107.js"><link rel="prefetch" href="/assets/js/13.f9475909.js"><link rel="prefetch" href="/assets/js/14.c25619a2.js"><link rel="prefetch" href="/assets/js/15.c21658ff.js"><link rel="prefetch" href="/assets/js/16.eeff6daa.js"><link rel="prefetch" href="/assets/js/17.4ebe621e.js"><link rel="prefetch" href="/assets/js/18.16c6ef6a.js"><link rel="prefetch" href="/assets/js/19.670532cc.js"><link rel="prefetch" href="/assets/js/21.997f8f04.js"><link rel="prefetch" href="/assets/js/22.853e5d9e.js"><link rel="prefetch" href="/assets/js/23.f05ab100.js"><link rel="prefetch" href="/assets/js/24.99a57a61.js"><link rel="prefetch" href="/assets/js/25.6b59790a.js"><link rel="prefetch" href="/assets/js/26.1a163d8d.js"><link rel="prefetch" href="/assets/js/4.933c17d3.js"><link rel="prefetch" href="/assets/js/5.52a6c039.js"><link rel="prefetch" href="/assets/js/6.1fd7acb8.js"><link rel="prefetch" href="/assets/js/7.40cf13a3.js"><link rel="prefetch" href="/assets/js/9.2036b282.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4e55ef28.css"><link rel="stylesheet" href="/assets/css/styles.4ccb282b.css"><link rel="stylesheet" href="/assets/css/8.styles.992b9188.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-1993cf69><div data-v-eab05d90 data-v-1993cf69><nav class="navbar" data-v-eab05d90><div class="container" data-v-eab05d90><a href="/" class="router-link-active" data-v-eab05d90><span class="navbar-site-name" data-v-eab05d90>
          Steffy's blog
        </span></a> <div class="navbar-toggler" data-v-eab05d90><svg class="icon" style="font-size:1.2em;" data-v-eab05d90 data-v-eab05d90><title data-v-eab05d90 data-v-eab05d90>menu</title><use xlink:href="#icon-menu" data-v-eab05d90 data-v-eab05d90></use></svg></div> <div class="navbar-links" data-v-eab05d90><a href="/" class="navbar-link" data-v-eab05d90>
            Accueil
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-eab05d90>
            Blog
          </a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-eab05d90></div></div> <div class="banner" data-v-66d98992 data-v-1993cf69 data-v-1993cf69><div class="container" data-v-66d98992><div class="center" data-v-66d98992><h1 data-v-66d98992 data-v-1993cf69>
          Créer sa station météo - partie 1
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-5c108b84 data-v-5c108b84><main class="main" data-v-5c108b84><div class="post" data-v-5c108b84 data-v-5c108b84><section class="post-meta main-div" data-v-0afc19fc><section class="post-date clearfix" data-v-0afc19fc><span class="create-date" data-v-0afc19fc>
      Créé le : 2021-05-01
    </span> <!----></section> <section class="post-links" data-v-0afc19fc><a href="/posts/2020/12/31/next-project.html" class="post-link" data-v-0afc19fc>
      Précédent : Idées pour de nouveaux projets
    </a> <a href="/posts/2021/05/14/projects-idea.html" class="post-link" data-v-0afc19fc>
      Suivant : Idées de projets pour 2021
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><h1 id="creer-sa-station-meteo-partie-1"><a href="#creer-sa-station-meteo-partie-1" class="header-anchor">#</a> Créer sa station météo - partie 1</h1> <p>Je vous avais parlé dans mon dernier article que je souhaitais me remettre à la programmation Arduino ainsi qu'à la programmation Python afin de tester des montages électroniques.</p> <p>C'est ce que j'ai fait pour créer ma propre station météo et je vais vous en parler dans cet article pour la partie &quot;Programmation Arduino&quot; et dans le prochain pour la partie &quot;Programmation Python&quot; qui sera plus sur de la programmation MicroPython.</p> <p>Pourquoi rédiger deux articles sur la création d'une station météo ? Lorsque j'ai acheté mon kit électronique, j'avais accès à un lien me permettant de récupérer une archive avec des informations pour connecter les composants entre eux et faire le programme associé. Mais en parcourant la documentation fournie, je me suis rendue compte que ce n'était pas si facile que ça à faire et qu'il n'existait pas de version pour le faire en microPython, d'où l'idée de ces deux articles.</p> <h2 id="materiel-necessaire"><a href="#materiel-necessaire" class="header-anchor">#</a> Matériel nécessaire</h2> <p>Pour faire ma station météo, j'utilise les composants suivants :</p> <ul><li>une carte ESP8266-12E</li> <li>un capteur de température et d'humidité DHT11</li> <li>un capteur de pression BMP180</li> <li>un capteur de lumière BH1750FVI</li> <li>un écran I2C OLED</li> <li>une breadboard et des fils dupont pour faire les connexions entre les différents éléments</li></ul> <p>Voici la carte des connexions entre la carte ESP8266-12E et les différents capteurs :</p> <table><thead><tr><th style="text-align:center;">ESP8266-12E</th> <th style="text-align:center;">I2C OLED</th> <th style="text-align:center;">BH1750FVI</th> <th style="text-align:center;">BMP180</th> <th style="text-align:center;">DHT11</th></tr></thead> <tbody><tr><td style="text-align:center;">GND</td> <td style="text-align:center;">GND</td> <td style="text-align:center;">GND</td> <td style="text-align:center;">GND</td> <td style="text-align:center;">GND</td></tr> <tr><td style="text-align:center;">3.3V</td> <td style="text-align:center;">VCC</td> <td style="text-align:center;">VCC</td> <td style="text-align:center;">VCC</td> <td style="text-align:center;">VCC</td></tr> <tr><td style="text-align:center;">D3</td> <td style="text-align:center;">SDA</td> <td style="text-align:center;">SDA</td> <td style="text-align:center;">SDA</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">D4</td> <td style="text-align:center;">SCL</td> <td style="text-align:center;">SCL</td> <td style="text-align:center;">SCL</td> <td style="text-align:center;"></td></tr> <tr><td style="text-align:center;">D5</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:center;">OUT</td></tr></tbody></table> <h2 id="que-va-faire-ce-programme"><a href="#que-va-faire-ce-programme" class="header-anchor">#</a> Que va faire ce programme ?</h2> <p>Sur l'écran, on va faire un affichage de type &quot;sliders&quot;, c'est-à-dire que l'écran va afficher 4 vues différentes qui vont se dérouler les unes à la suite des autres :</p> <ul><li>la date et l'heure,</li> <li>la météo du jour,</li> <li>la météo à 3 jours,</li> <li>les données des capteurs : température, humidité, pression et luminosité</li></ul> <p>Pour la récupération des informations météo, on utilise l'API d'<a href="https://openweathermap.org/" target="_blank" rel="noopener noreferrer">OpenWeatherMap<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Pour cela, il faut se créer un compte afin de se créer une clé d'API que l'on pourra ensuite passer dans les appels que l'on fera dans l'application.</p> <p>La plupart des exemples que j'ai trouvé utilisaient aussi l'API de <a href="https://thingspeak.com/" target="_blank" rel="noopener noreferrer">ThingSpeak<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> mais je n'avais pas envie de pousser les données lues sur les capteurs vers le Web, je voulais juste les afficher sur l'écran - histoire de réfléchir au code pour afficher correctement les données sur l'écran.</p> <p>J'ai créé un projet Github qui va contenir tous les fichiers que je vais utiliser dans cet article est le suivant: <a href="https://github.com/Steffy29/weatherstation-demo" target="_blank" rel="noopener noreferrer">weatherstation-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="programmation-arduino"><a href="#programmation-arduino" class="header-anchor">#</a> Programmation Arduino</h2> <p>Pour bien commencer, on va configurer Arduino avec tous les éléments dont on a besoin.</p> <h3 id="arduino-ide"><a href="#arduino-ide" class="header-anchor">#</a> Arduino IDE</h3> <p>L'IDE pour programmer les cartes Arduino et autres est disponible <a href="https://www.arduino.cc/en/software" target="_blank" rel="noopener noreferrer">ici<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Il vous permettra de coder votre application et de la charger ensuite sur la carte ESP8266 pour tester votre programme après l'avoir compilé.</p> <h3 id="configurer-arduino-ide"><a href="#configurer-arduino-ide" class="header-anchor">#</a> Configurer Arduino IDE</h3> <p>On va tout d'abord ajouter la gestion des cartes ESP8266 à Arduino IDE. Pour cela, vous allez dans <code>Fichier-&gt;Préférences</code> et ajouter dans <code>URL de gestionnaire de cartes supplémentaires</code> le lien : <a href="https://arduino.esp8266.com/stable/package_esp8266com_index.json" target="_blank" rel="noopener noreferrer">https://arduino.esp8266.com/stable/package_esp8266com_index.json<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p></p><div class="text-align-center"><img src="/add_package_esp8266com.png" alt="Ajout de la gestion des cartes ESP8266"></div><p></p> <p>Une fois l'ajout fait, il suffit de fermer cet écran en cliquant sur <code>OK</code>. On va ensuite dans <code>Outils-&gt;Type de cartes-&gt;Gestionnaire de carte</code>. Dans la partie recherche, on saisit &quot;esp8266&quot; pour filtrer les résultats et on installe la version &quot;ESP8266 by ESP8266 Community&quot; en cliquant sur le bouton <code>Installer</code>.</p> <p></p><div class="text-align-center"><img src="/cardboard_manager.png" alt="Gestionnaire de carte - sélection ESP8266"></div><p></p> <p>Quand l'installation est terminée, on peut fermer cet écran en cliquant sur le bouton <code>Fermer</code>.</p> <p>Si on retourne dans le menu <code>Outils-&gt;Type de carte-&gt;ESP8266 Boards(2.7.4)</code>, on peut maintenant sélectionner la carte que l'on va utiliser dans notre montage <code>NodeMCU 1.0 (ESP-12E module)</code>.</p> <p>On va maintenant choisir le port sur lequel la carte est connectée, en allant dans <code>Outils-&gt;Port</code> et là on choisit le port où la carte est connectée (ne pas oublier de la brancher via le câble USB 😉 ).</p> <h3 id="importer-le-projet-weatherstation-demo-a-arduino-ide"><a href="#importer-le-projet-weatherstation-demo-a-arduino-ide" class="header-anchor">#</a> Importer le projet weatherstation-demo à Arduino IDE</h3> <p>Après avoir cloné le projet Github weatherstation-demo, on va dans <code>Fichier-&gt;Ouvrir</code> pour charger le fichier <code>WeatherStationDemo.ino</code> qui se trouve dans <code>weatherstation-demo/arduino/WeatherStationDemo</code>. Le fichier est chargé dans l'IDE ainsi que les fichiers <code>WeatherStationFonts.h</code> et <code>WeatherStationImage.h</code> qui contiennent les définitions des fonts et images utilisées dans l'affichage des informations sur l'écran OLED.</p> <p></p><div class="text-align-center"><img src="/load_weatherstation_demo.png" alt="Chargement du fichier WeatherStationDemo"></div><p></p> <h3 id="ajouter-des-librairies-a-arduino-ide"><a href="#ajouter-des-librairies-a-arduino-ide" class="header-anchor">#</a> Ajouter des librairies à Arduino IDE</h3> <p>Pour ajouter une librairie, on va dans <code>Croquis-&gt;Inclure une bibliothèque-&gt;Ajouter la bibliothèque .ZIP...</code>.</p> <p></p><div class="text-align-center"><img src="/add_library_zip_file.png" alt="Ajout d'une bibliothèque"></div><p></p> <p>On va ajouter les 3 fichiers suivants :</p> <ul><li><code>weatherstation-demo/arduino/libs/esp8266-weather-station-master.zip</code></li> <li><code>weatherstation-demo/arduino/libs/json-streaming-parser-master.zip</code></li> <li><code>weatherstation-demo/arduino/libs/esp8266-oled-ssd1306-master.zip</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">Attention</p> <p>Lors des tests que j'ai effectué pour rédiger cet article, j'ai quelques erreurs de compilation. Ces erreurs venaient du fait que la librairie <code>esp8266-weather-station-master</code> n'était pas installée dans sa dernière version (2.0.1) ce qui générait des erreurs de fichiers manquants ou en erreur.</p> <p></p><div class="text-align-center"><img src="/esp8266_weather_station_master_last_version.png" alt="Connaître la version d'une librairie"></div><p></p></div> <p>On va aussi ajouter la librairie d'Adafruit Adafruit_BMP085. Pour cela, on va faire <code>Croquis-&gt;Inclure une bibliothèque-&gt;Gérer les bibliothèques</code>. Comme pour l'ajout de nouvelles cartes, on va chercher les librairies correspondants au capteur &quot;BMP085&quot;.</p> <p></p><div class="text-align-center"><img src="/add_adafruit_bmp085.png" alt="Ajout de la librairie Adafruit_BMP085"></div><p></p> <p>On clique sur le bouton &quot;Installer&quot; pour ajouter cette librairie à notre projet. Il est possible qu'un message de dépendances manquantes s'affiche, pour être sûr que tout se passe bien lors de la compilation, on clique sur &quot;Install all&quot; pour avoir aussi les dépendances. Lorsque l'installation est terminée, on n'a plus qu'à cliquer sur le bouton &quot;Fermer&quot; pour fermer cet écran.</p> <h3 id="mise-a-jour-du-code"><a href="#mise-a-jour-du-code" class="header-anchor">#</a> Mise à jour du code</h3> <p>Dans le fichier <code>WeatherStationDemo.ino</code>, il faut mettre à jour les éléments de connexion au Wifi ainsi que la clé d'API pour OpenWeatherMap :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">/***************************
 * WIFI Settings
 **************************/</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> WIFI_SSID <span class="token operator">=</span> <span class="token string">&quot;your_wifi_ssid&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> WIFI_PWD <span class="token operator">=</span> <span class="token string">&quot;your_wifi_pwd&quot;</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// OpenWeatherMap Settings</span>
<span class="token comment">// Sign up here to get an API key:</span>
<span class="token comment">// https://docs.thingpulse.com/how-tos/openweathermap-key/</span>
<span class="token keyword">const</span> boolean IS_METRIC <span class="token operator">=</span> true<span class="token punctuation">;</span>
String OPEN_WEATHER_MAP_APP_ID <span class="token operator">=</span> <span class="token string">&quot;your_openweathermap_app_id&quot;</span><span class="token punctuation">;</span>
String OPEN_WEATHER_MAP_LOCATION <span class="token operator">=</span> <span class="token string">&quot;your_location&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="tester-le-programme"><a href="#tester-le-programme" class="header-anchor">#</a> Tester le programme</h3> <p>Pour tester si tout fonctionne bien, on va compiler et charger le programme sur la carte ESP8266. Tout d'abord, on va vérifier que le programme compile en cliquant sur le bouton &quot;Vérifier&quot; dans l'IDE.</p> <p></p><div class="text-align-center"><img src="/compile_program.png" alt="Vérifier le programme"></div><p></p> <p>Si la vérification est correcte (il n'y pas d'erreur), on va pouvoir le charger sur la carte en cliquant sur le bouton &quot;Téléverser avec un programmateur&quot; dans l'IDE. Attention, cela peut prendre un peu de temps car il y a d'abord la compilation avant de charger le binaire sur la carte.</p> <p></p><div class="text-align-center"><img src="/upload_program.png" alt="Téléverser avec un programmateur"></div><p></p> <h2 id="comprendre-le-code"><a href="#comprendre-le-code" class="header-anchor">#</a> Comprendre le code</h2> <p>Un programme Arduino de base a 2 fonctions :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Ce programme n'échappe pas à la règle mais avec en plus les définitions de constantes et de variables qui vont être utilisées tout au long du programme :</p> <ul><li>WIFI,</li> <li>DHT11,</li> <li>Atmosphere et capteur de lumière,</li> <li>I2C OLED,</li> <li>intervalle de mise à jour,</li> <li>Time zone (TZ),</li> <li>OpenWeatherMap,</li> <li>OLED display UI</li></ul> <p>Ensuite, on déclare les prototypes des fonctions qui seront utilisées dans le programme :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">drawProgress</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> <span class="token keyword">int</span> percentage<span class="token punctuation">,</span> String label<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage d'une barre de proggresion</span>
<span class="token keyword">void</span> <span class="token function">updateData</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// mise à jour des données affichées sur l'écran</span>
<span class="token keyword">void</span> <span class="token function">drawDateTime</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">,</span> int16_t x<span class="token punctuation">,</span> int16_t y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage de la date et heure</span>
<span class="token keyword">void</span> <span class="token function">drawCurrentWeather</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">,</span> int16_t x<span class="token punctuation">,</span> int16_t y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage de la météo du jour</span>
<span class="token keyword">void</span> <span class="token function">drawForecast</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">,</span> int16_t x<span class="token punctuation">,</span> int16_t y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage de la météo à 3 jours</span>
<span class="token keyword">void</span> <span class="token function">drawForecastDetails</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> dayIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage du détail de la météo</span>
<span class="token keyword">void</span> <span class="token function">drawHeaderOverlay</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage du bas de page de l'écran avec l'heure et la température</span>
<span class="token keyword">void</span> <span class="token function">drawTempIntern</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">,</span> int16_t x<span class="token punctuation">,</span> int16_t y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// affichage des informations récupérées via les capteurs</span>
<span class="token keyword">void</span> <span class="token function">setReadyForWeatherUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pour faire les mises à jour des données</span>
</code></pre></div><p>Les affichages changent régulièrement grâce au code suivant :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// Add frames</span>
<span class="token comment">// this array keeps function pointers to all frames</span>
<span class="token comment">// frames are the single views that slide from right to left</span>
FrameCallback frames<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> drawDateTime<span class="token punctuation">,</span> drawCurrentWeather<span class="token punctuation">,</span> drawForecast<span class="token punctuation">,</span> drawTempIntern <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> numberOfFrames <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
OverlayCallback overlays<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> drawHeaderOverlay <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> numberOfOverlays <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>Je ne vais pas détailler toutes les fonctions du code, je vais juste faire un focus sur 2 fonctions que j'ai trouvé intéressantes.</p> <h3 id="fonctions-de-dessin"><a href="#fonctions-de-dessin" class="header-anchor">#</a> Fonctions de dessin</h3> <p>Si on prend, par exemple, la fonction <code>drawCurrentWeather</code> qui permet d'afficher la météo du jour dont voici le code :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">drawCurrentWeather</span><span class="token punctuation">(</span>OLEDDisplay <span class="token operator">*</span>display<span class="token punctuation">,</span> OLEDDisplayUiState<span class="token operator">*</span> state<span class="token punctuation">,</span> int16_t x<span class="token punctuation">,</span> int16_t y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  display<span class="token operator">-&gt;</span><span class="token function">setFont</span><span class="token punctuation">(</span>ArialMT_Plain_10<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">setTextAlignment</span><span class="token punctuation">(</span>TEXT_ALIGN_CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token number">64</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token number">38</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> currentWeather<span class="token punctuation">.</span>description<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">setFont</span><span class="token punctuation">(</span>ArialMT_Plain_24<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">setTextAlignment</span><span class="token punctuation">(</span>TEXT_ALIGN_LEFT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  String temp <span class="token operator">=</span> <span class="token function">String</span><span class="token punctuation">(</span>currentWeather<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>IS_METRIC <span class="token operator">?</span> <span class="token string">&quot;°C&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;°F&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token number">5</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">setFont</span><span class="token punctuation">(</span>Meteocons_Plain_36<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">setTextAlignment</span><span class="token punctuation">(</span>TEXT_ALIGN_CENTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display<span class="token operator">-&gt;</span><span class="token function">drawString</span><span class="token punctuation">(</span><span class="token number">32</span> <span class="token operator">+</span> x<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token operator">+</span> y<span class="token punctuation">,</span> currentWeather<span class="token punctuation">.</span>iconMeteoCon<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dans cette fonction, on peut noter que l'on mélange à la fois l'affichage <code>display-&gt;</code> et la récupération de données <code>String temp =...</code>.
L'affichage dans l'écran se fait en 2 temps, d'abord on sélectionne la font ou l'image que l'on va afficher ainsi que l'alignement du texte, et ensuite, on affiche <code>drawString</code> le résultat en donnant la position de départ sur l'écran (x et y) et la donnée à afficher.</p> <h3 id="fonctions-de-lecture-des-capteurs"><a href="#fonctions-de-lecture-des-capteurs" class="header-anchor">#</a> Fonctions de lecture des capteurs</h3> <p>Si on prend, par exemple, la fonction <code>readAtmosphere</code> qui permet de lire la pression atmosphérique du capteur BPM280 dont voici le code :</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">readAtmosphere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  tempAtom <span class="token operator">=</span> bmp<span class="token punctuation">.</span><span class="token function">readPressure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;Pressure = &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>tempAtom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Serial<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; Pascal&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Dans cette fonction, on va lire la pression du capteur via l'utilisation de la librairie d'Adafruit que l'on a ajouté au projet. L'avantage de cette librairie est que les données lues sont directement exploitable (elles ont en Pascal) et l'on n'a pas besoin de faire des calculs du genre :</p> <div class="language- extra-class"><pre class="language-text"><code>float B = 1 / 5.25588;
float calcAltitude(float p0, float p1, float t) {
  float C = pow((p0 / p1), B) - 1.0;
  return (C * (t + 273.15)) / 0.0065;
}
</code></pre></div><p>Merci <a href="https://twitter.com/Kongduino" target="_blank" rel="noopener noreferrer">@Kongduino<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> pour les explications et le code.</p> <h2 id="conclusion"><a href="#conclusion" class="header-anchor">#</a> Conclusion</h2> <p>Et voilà, cette première partie est terminée même si elle était déjà un peu longue. Dans la prochaine partie, je décrirai la version faite en MicroPython. En attendant, le code et les librairies sont disponibles sur mon Github <a href="https://github.com/Steffy29/weatherstation-demo" target="_blank" rel="noopener noreferrer">weatherstation-demo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>Have fun !</p></div></article> <section class="post-meta main-div" data-v-0afc19fc><section class="post-date clearfix" data-v-0afc19fc><span class="create-date" data-v-0afc19fc>
      Créé le : 2021-05-01
    </span> <!----></section> <section class="post-links" data-v-0afc19fc><a href="/posts/2020/12/31/next-project.html" class="post-link" data-v-0afc19fc>
      Précédent : Idées pour de nouveaux projets
    </a> <a href="/posts/2021/05/14/projects-idea.html" class="post-link" data-v-0afc19fc>
      Suivant : Idées de projets pour 2021
    </a></section></section> <!----></div></main> <aside class="aside" data-v-5c108b84><div class="info-card main-div" data-v-14fee2b8 data-v-5c108b84><div class="info-card-header" data-v-14fee2b8><img src="https://avatars1.githubusercontent.com/u/2368951?s=400&amp;u=e323181014655a527f67ba8c8ba12e35f6c31340&amp;v=4" alt="Steffy29" class="info-avatar" data-v-14fee2b8></div> <div class="info-card-body" data-v-14fee2b8><section class="info-nickname" data-v-14fee2b8>
      Steffy29
    </section> <section class="info-desc" data-v-14fee2b8>Blog, tutos, conférences et autres</section> <section class="info-contact" data-v-14fee2b8><section data-v-14fee2b8><span title="Plougastel-Daoulas, France" data-v-14fee2b8 data-v-14fee2b8><svg class="icon" style="font-size:1em;" data-v-14fee2b8 data-v-14fee2b8><title data-v-14fee2b8 data-v-14fee2b8>Plougastel-Daoulas, France</title><use xlink:href="#icon-location" data-v-14fee2b8 data-v-14fee2b8></use></svg><span class="info-text" data-v-14fee2b8 data-v-14fee2b8>
          Plougastel-Daoulas, France
        </span></span></section> <!----> <section data-v-14fee2b8><a href="mailto:stephanie.moallic@gmail.com" title="stephanie.moallic@gmail.com" data-v-14fee2b8 data-v-14fee2b8><svg class="icon" style="font-size:1em;" data-v-14fee2b8 data-v-14fee2b8><title data-v-14fee2b8 data-v-14fee2b8>stephanie.moallic@gmail.com</title><use xlink:href="#icon-email" data-v-14fee2b8 data-v-14fee2b8></use></svg><span class="info-text" data-v-14fee2b8 data-v-14fee2b8>
          stephanie.moallic@gmail.com
        </span></a></section></section></div> <div class="info-card-footer" data-v-14fee2b8><section class="info-sns clearfix" data-v-14fee2b8><a href="https://github.com/Steffy29" target="_blank" class="sns-link" data-v-14fee2b8><span title="GitHub: Steffy29" class="sns-icon" data-v-14fee2b8 data-v-14fee2b8><svg class="icon" style="font-size:1.5em;" data-v-14fee2b8 data-v-14fee2b8><title data-v-14fee2b8 data-v-14fee2b8>GitHub: Steffy29</title><use xlink:href="#icon-github" data-v-14fee2b8 data-v-14fee2b8></use></svg></span></a><a href="https://twitter.com/steffy_29" target="_blank" class="sns-link" data-v-14fee2b8><span title="Twitter: steffy_29" class="sns-icon" data-v-14fee2b8 data-v-14fee2b8><svg class="icon" style="font-size:1.5em;" data-v-14fee2b8 data-v-14fee2b8><title data-v-14fee2b8 data-v-14fee2b8>Twitter: steffy_29</title><use xlink:href="#icon-twitter" data-v-14fee2b8 data-v-14fee2b8></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-5c108b84><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>Table des contenus</span> <div class="post-nav-toc"><ul><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#materiel-necessaire">Matériel nécessaire</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#que-va-faire-ce-programme">Que va faire ce programme ?</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#programmation-arduino">Programmation Arduino</a><ul><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#arduino-ide">Arduino IDE</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#configurer-arduino-ide">Configurer Arduino IDE</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#importer-le-projet-weatherstation-demo-a-arduino-ide">Importer le projet weatherstation-demo à Arduino IDE</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#ajouter-des-librairies-a-arduino-ide">Ajouter des librairies à Arduino IDE</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#mise-a-jour-du-code">Mise à jour du code</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#tester-le-programme">Tester le programme</a></li></ul></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#comprendre-le-code">Comprendre le code</a><ul><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#fonctions-de-dessin">Fonctions de dessin</a></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#fonctions-de-lecture-des-capteurs">Fonctions de lecture des capteurs</a></li></ul></li><li><a href="/posts/2021/05/01/create-a-weather-station-part-1.html#conclusion">Conclusion</a></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-2c67d6af><p class="footer-sns-links" data-v-2c67d6af><a href="https://github.com/Steffy29" target="_blank" class="sns-link" data-v-2c67d6af><span title="GitHub: Steffy29" class="sns-icon" data-v-2c67d6af data-v-2c67d6af><svg class="icon" style="font-size:25px;" data-v-2c67d6af data-v-2c67d6af><title data-v-2c67d6af data-v-2c67d6af>GitHub: Steffy29</title><use xlink:href="#icon-github" data-v-2c67d6af data-v-2c67d6af></use></svg></span></a><a href="https://twitter.com/steffy_29" target="_blank" class="sns-link" data-v-2c67d6af><span title="Twitter: steffy_29" class="sns-icon" data-v-2c67d6af data-v-2c67d6af><svg class="icon" style="font-size:25px;" data-v-2c67d6af data-v-2c67d6af><title data-v-2c67d6af data-v-2c67d6af>Twitter: steffy_29</title><use xlink:href="#icon-twitter" data-v-2c67d6af data-v-2c67d6af></use></svg></span></a></p> <p class="footer-text" data-v-2c67d6af><span data-v-2c67d6af>Powered by </span> <a href="https://github.com/vuejs/vuepress" target="_blank" data-v-2c67d6af>
      VuePress
    </a> <span data-v-2c67d6af> | </span> <a href="https://github.com/meteorlxy/vuepress-theme-meteorlxy" target="_blank" data-v-2c67d6af>
        meteorlxy
      </a></p> <!----></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/vendor.vue.dbbf1d4d.js" defer></script><script src="/assets/js/8.992b9188.js" defer></script><script src="/assets/js/20.a2ce34d7.js" defer></script><script src="/assets/js/vendor.commons.4e55ef28.js" defer></script><script src="/assets/js/app.4ccb282b.js" defer></script>
  </body>
</html>
